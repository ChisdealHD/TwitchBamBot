<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>thatsBamBot</title>
    <link rel="stylesheet" href="css/user-list.css">
</head>

<body>
    <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="js/socket.io.js"></script>
    HEY I'M THE BOT
    <br> set your colour in chat:
    <br> colour [colour name]
    <ul class="user-list"></ul>
    <script>
    var options = {
        disconnected: false
    };

    var socket = io();

    socket.on('usersWithColours', function(data) {
        syncUsersAndColor(data);
    });

    socket.on('usersWithPoints', function(data) {
        updateUsersWithPoints(data);
    });

    socket.on('users', function(data) {
        updateUserList(data);
    });

    socket.on('sfx', function(file) {
        var audio = document.createElement("AUDIO");
        audio.src = file;
        audio.autoplay = true;
        document.body.appendChild(audio);
        audio.addEventListener("ended", function() {
            document.body.removeChild(audio);
        }, true);

        audio.addEventListener("error", function() {
            document.body.removeChild(audio);
        }, true);
    });

    //disconnect/reconnect
    socket.on('connection', function() {
        options.disconnected = false;
        console.log("CONNECTED");
    });

    socket.on('reconnect', function() {
        options.disconnected = false;
        console.log("RECONNECTED");
    });

    socket.on('disconnect', function() {
        options.disconnected = true;
        console.log("DISCONNECT");
        startRefresh();
    });

    function startRefresh() {
        socket.io.reconnect();
        console.log("RECONNECT ATTEMPT");
        setTimeout(function() {
            if (options.disconnected === true) startRefresh();
        }, 1000);
    }

    function syncUsersAndColor(data) {
        var userList = $(".user-list");

        data.forEach(function(userObj) {
            var username = userObj.key,
                userColor = userObj.value,
                currentEl = $("[data-user='" + username + "']");

            currentEl.attr("data-color", userColor);

            currentEl.css({
                color: userColor
            });
        })
    }

    function updateUserList(data) {
        var userList = $(".user-list"),
            currentUsers = userList.children();

        currentUsers.each(function(i, user) {
            var $user = $(user),
                username = $user.attr("data-user");

            if (data.indexOf(username) === -1) $user.remove();
        });


        data.forEach(function(username) {
            var currentEl = $("[data-user='" + username + "']");

            if (currentEl.length === 0) {
                var listItem = $("<li/>");

                listItem
                    .html(username)
                    .attr("data-user", username);

                userList.append(listItem);
            }
        })
    }

    function updateUsersWithPoints(data) {
        data.forEach(function(userObj) {
            var username = userObj.key,
                points = userObj.value,
                currentEl = $("[data-user='" + username + "']");

            currentEl.attr("data-points", points);
        })
    }
    </script>
</body>

</html>
